@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model WebNangCao_MVC_Model.Models.Exam
@{
    ViewData["Title"] = "Làm bài thi";
    Layout = null;

    // Khai báo biến toàn cục cho trang để dùng ở nhiều nơi
    //đếm số câu hỏi, nếu bảng câu hỏi rỗng thì trả về 0 thay vì lỗi NULL
    var totalQs = Model?.Questions?.Count ?? 0;
}

<!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>@ViewData["Title"]</title>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="~/css/GiaoDienLamBai.css" />
    </head> 
    <body>
    <!---->
    @Html.AntiForgeryToken()
    <header class="test-header">
        <div class="header-title">
            <h1>@Model?.Title</h1>
            <p>Thời gian: @Model?.Duration phút</p>
        </div>
        <div class="header-actions">
            <div class="timer-badge">
                <i data-lucide="clock" width="20" height="20"></i>
                <span id="countdownDisplay">00:00</span>
            </div>
            <button class="btn-submit" onclick="submitExam()">
                <i data-lucide="send" width="16" height="16"></i>
                <span>Nộp bài</span>
            </button>
        </div>
    </header>

    <main class="test-container">
        <div class="main-content">
            <div class="card">
                <div class="progress-header">
                    <span>Tiến độ: 0/@totalQs câu</span>
                    <span class="percent">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            @{
                int qIdx = 1;
            }
            @if (Model?.Questions != null)
            {
                foreach (var question in Model.Questions)
                {
                    <div class="card question-block" id="question-block-@qIdx" style="display: @(qIdx == 1 ? "block" : "none");">
                        <div class="question-header">
                            <div class="question-title-wrapper">
                                <div class="question-number">@qIdx</div>
                                <div class="question-title">
                                    <h2>Câu hỏi @qIdx</h2>
                                    <span class="badge-difficulty">@question.Difficulty</span>
                                </div>
                            </div>
                            <button class="btn-flag" type="button" title="Đánh dấu xem lại">
                                <i data-lucide="flag" width="20" height="20"></i>
                            </button>
                        </div>

                        <div class="question-text">
                            @Html.Raw(question.Content)
                        </div>

                        <div class="answer-list">
                            @if (question.Answers != null)
                            {
                                char optionLetter = 'A'; // Biến để sinh chữ A, B, C, D
                                foreach (var answer in question.Answers)
                                {
                                    <label class="answer-option">
                                        <input type="radio" name="question_@question.Id" value="@answer.Id">
                                        <span>@optionLetter. @answer.Content</span>
                                    </label>
                                    optionLetter++;
                                }
                            }
                        </div>

                        <div class="question-nav">
                            <button type="button" class="btn-nav btn-nav-prev" onclick="prevQuestion()" @(qIdx == 1 ? "disabled" : "")>
                                <i data-lucide="chevron-left" width="18" height="18"></i> Câu trước
                            </button>

                            <span style="color: var(--text-muted); font-size: 14px; font-weight: 500;">@qIdx / @totalQs</span>

                            <button type="button" class="btn-nav btn-nav-next" onclick="nextQuestion()">
                                Câu sau <i data-lucide="chevron-right" width="18" height="18"></i>
                            </button>
                        </div>
                    </div>
                    qIdx++;
                }
            }
        </div>

        <aside class="sidebar card">
            <h3>Danh sách câu hỏi</h3>

            <div class="filter-tabs">
                <button class="filter-tab active">Tất cả</button>
                <button class="filter-tab">Đã làm</button>
                <button class="filter-tab">Đánh dấu</button>
            </div>

            <div class="question-grid">
                @for (int i = 1; i <= totalQs; i++)
                {
                    <button type="button" class="grid-item @(i == 1 ? "active" : "")" onclick="jumpToQuestion(@i)">@i</button>
                }
            </div>

            <div class="legend-list">
                <div class="legend-item">
                    <div class="legend-left">
                        <div class="legend-box box-answered"></div>
                        <span>Đã trả lời</span>
                    </div>
                    <span class="legend-count">0</span>
                </div>
                <div class="legend-item">
                    <div class="legend-left">
                        <div class="legend-box box-unanswered"></div>
                        <span>Chưa trả lời</span>
                    </div>
                    <span class="legend-count">@totalQs</span>
                </div>
                <div class="legend-item">
                    <div class="legend-left">
                        <i data-lucide="flag" width="14" height="14" style="color: var(--warning-color); fill: var(--warning-color)"></i>
                        <span>Đánh dấu</span>
                    </div>
                    <span class="legend-count">0</span>
                </div>
            </div>
        </aside>
    </main>

    <!--Giao diện nộp bài-->
    <!--nó sẽ hiện lên sau khi nhấn nút Submit-->
    <div id="submitModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <i data-lucide="circle-alert" class="icon-warning" width="24" height="24"></i>
                <h2>Xác nhận nộp bài</h2>
            </div>

            <div class="modal-body">
                <p class="modal-desc">Bạn có chắc chắn muốn nộp bài?</p>

                <div class="stats-box">
                    <div class="stat-row">
                        <span>Đã trả lời:</span>
                        <span id="modal-answered" class="stat-value">0/10 câu</span>
                    </div>
                    <div class="stat-row">
                        <span>Chưa trả lời:</span>
                        <span id="modal-unanswered" class="stat-value">10 câu</span>
                    </div>
                    <div class="stat-row">
                        <span>Đã đánh dấu:</span>
                        <span id="modal-flagged" class="stat-value">0 câu</span>
                    </div>
                </div>

                <div id="modal-warning-box" class="warning-box">
                    <i data-lucide="circle-alert" width="18" height="18"></i>
                    <span id="modal-warning-text">Bạn còn 10 câu chưa trả lời. Bài làm sẽ không thể chỉnh sửa sau khi nộp.</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeSubmitModal()">Tiếp tục làm bài</button>
                <button type="button" class="btn-confirm-submit" onclick="executeSubmit()">
                    <i data-lucide="send" width="16" height="16"></i> Nộp bài
                </button>
            </div>
        </div>
    </div>

    <!--Giao diện tính xong kết quả-->
    <!--Cần biết có bao nhiêu câu Dễ/Trung bình/ Khó đã đúng cho người dùng biết-->
    <div id="resultModal" class="modal-overlay" style="display: none;">
        <div class="modal-content result-content">
            <div class="result-header">
                <div class="success-icon-wrapper">
                    <i data-lucide="check-circle" width="36" height="36"></i>
                </div>
                <h2>Nộp bài thành công!</h2>
                <p class="text-muted">Hệ thống đã ghi nhận kết quả của bạn.</p>
            </div>

            <div class="result-body">
                <div class="score-circle">
                    <span id="result-score" class="score-number">0.0</span>
                    <span class="score-label">Điểm số</span>
                </div>

                <div class="result-details">
                    <div class="detail-row" style="border-bottom: 1px dashed var(--border-color); padding-bottom: 12px; margin-bottom: 12px;">
                        <span>Tổng số câu đúng:</span>
                        <span id="result-correct" class="detail-value text-success">0/0</span>
                    </div>

                    <div class="difficulty-breakdown" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="detail-row" style="font-size: 14px;">
                            <span><span style="color: #22c55e; margin-right: 6px;">●</span> Mức độ Dễ:</span>
                            <span id="result-easy" class="detail-value" style="font-weight: 600;">0 câu</span>
                        </div>
                        <div class="detail-row" style="font-size: 14px;">
                            <span><span style="color: #f59e0b; margin-right: 6px;">●</span> Mức độ Trung bình:</span>
                            <span id="result-medium" class="detail-value" style="font-weight: 600;">0 câu</span>
                        </div>
                        <div class="detail-row" style="font-size: 14px;">
                            <span><span style="color: #ef4444; margin-right: 6px;">●</span> Mức độ Khó:</span>
                            <span id="result-hard" class="detail-value" style="font-weight: 600;">0 câu</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-primary" onclick="goToResultPage()">
                    Xem chi tiết <i data-lucide="arrow-right" width="16" height="16"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const TIME_LIMIT_MINUTES = @(Model?.Duration ?? 0);
    </script>
    <script src="~/js/GiaoDienLamBai.js" asp-append-version="true"></script>

    </body>

    </html>
